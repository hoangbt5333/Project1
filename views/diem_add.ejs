<div class="space-y-6">
  <div class="flex items-center justify-between">
    <h2 class="text-2xl font-bold text-slate-800">Nhập điểm</h2>
  </div>

  <form action="/diem/add" method="get" class="bg-white rounded-2xl shadow-sm border border-slate-100 p-5 flex items-end gap-3">
    <div class="flex-1">
      <label class="block text-sm font-semibold text-slate-700 mb-1">Chọn môn học</label>
      <select name="ma_mon_hoc" onchange="this.form.submit()" class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-white focus:ring-2 focus:ring-brand focus:border-brand">
        <option value="">--Chọn--</option>
        <% monhocList.forEach(m => { %>
          <option value="<%= m.ma_mon_hoc %>" <%= maMonHoc && maMonHoc == m.ma_mon_hoc ? 'selected' : '' %>><%= m.ten_mon_hoc %></option>
        <% }) %>
      </select>
    </div>
  </form>

  <% if (sinhvienList.length > 0) { %>
    <form action="/diem/add" method="post" class="bg-white rounded-2xl shadow-sm border border-slate-100 p-5 space-y-4">
      <input type="hidden" name="ma_mon_hoc" value="<%= maMonHoc %>">
      <div class="overflow-x-auto table-scroll">
        <table class="min-w-full text-left text-sm text-slate-700">
          <thead class="table-head">
            <tr>
              <th class="px-4 py-3">Mã SV</th>
              <th class="px-4 py-3">Họ tên</th>
              <th class="px-4 py-3">Điểm chữ</th>
              <th class="px-4 py-3">Điểm số</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100">
            <% sinhvienList.forEach((sv, i) => { %>
              <tr class="hover:bg-slate-50 transition">
                <td class="px-4 py-3 font-semibold text-slate-800"><%= sv.ma_sv %></td>
                <td class="px-4 py-3"><%= sv.ho_ten %></td>
                <td class="px-4 py-3">
                  <input name="sinhvien[<%= i %>][diem_chu]" id="diem_chu_<%= i %>" oninput="updateScore(<%= i %>)" value="<%= sv.diem_chu || '' %>" class="w-full px-3 py-2 border border-slate-200 rounded-lg bg-slate-50 focus:ring-2 focus:ring-brand focus:border-brand">
                </td>
                <td class="px-4 py-3">
                  <input name="sinhvien[<%= i %>][diem_so]" id="diem_so_<%= i %>" value="<%= sv.diem_so || '' %>" class="w-full px-3 py-2 border border-slate-200 rounded-lg bg-slate-50 focus:ring-2 focus:ring-brand focus:border-brand">
                </td>
                <input type="hidden" name="sinhvien[<%= i %>][ma_sv]" value="<%= sv.ma_sv %>">
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
      <button type="submit" class="px-5 py-3 bg-brand text-white font-semibold rounded-xl hover:bg-brand-soft transition">Lưu điểm</button>
    </form>
  <% } %>
</div>

<script>
  const gradeMap = { 'A+': 4.0, 'A': 4.0, 'B+': 3.5, 'B': 3.0, 'C+': 2.5, 'C': 2.0, 'D+': 1.5, 'D': 1.0, 'F': 0.0 };
  function updateScore(rowIndex){
    const diemChuInput = document.querySelector(`#diem_chu_${rowIndex}`);
    const diemSoInput = document.querySelector(`#diem_so_${rowIndex}`);
    if(!diemChuInput || !diemSoInput) return;
    const diemChu = diemChuInput.value.toUpperCase();
    diemSoInput.value = gradeMap.hasOwnProperty(diemChu) ? gradeMap[diemChu] : '';
  }
</script>
